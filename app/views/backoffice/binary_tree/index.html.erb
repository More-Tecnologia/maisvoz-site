<div class="content-page">
  <!-- Start content -->
  <div class="content">
    <div class="container">

      <!-- Page-Title -->
      <div class="row">
        <div class="col-sm-12">
          <h4 class="page-title"><%= t('.title') %></h4>
          <p class="text-muted page-title-alt"><%= t('.subtitle') %></p>
        </div>
      </div>

      <div class="row">
        <div class="col-sm-12">
          <div class="card-box">
            <div class="row">
              <div class="col-lg-12">
                <div id="binary-tree"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>

  var nodz = <%= raw nodes %>

  var initTree = function (nodes) {
    var config = {
      chart: {
        container: "#binary-tree",
        connectors: {
          type: "curve",
          style: {
            "stroke-width": 2,
            "stroke-linecap": "round",
            "stroke": "#ccc"
          }
        },
        padding:    50,
        levelSeparation:    25,
        siblingSeparation:  50,
        subTeeSeparation:   50,
        node: {
    			HTMLclass: "tree-node"
    		}
      },
      nodeStructure: nodes.root
    }

    new Treant(config);

    var find_node_by_id = function(id, rootNode) {
      if (rootNode == null) { return false }
      if (rootNode.children == null) { return false }
      if (rootNode.HTMLid == id) { return rootNode.data }

      var left  = find_node_by_id(id, rootNode.children[0]);
      var right = find_node_by_id(id, rootNode.children[1]);

      return left ? left : right;
    }

    $('.tree-node').popover({
      trigger: 'hover',
      html: true,
      content: function() {
        var id = $(this).attr('id');
        var html = '';

        var node = find_node_by_id(id, nodes.root)

        if (id) {
          html += 'Sponsor: <strong>' + node.sponsor + '</strong><br />';
          html += 'Username: <strong>' + node.username + '</strong>';
        } else {
          html = 'no data';
        }

        return html;
      }
    });

    $('.tree-node').click(function() {
      var id = $(this).attr('id');

      if (id) {
        $.get('/backoffice/binary_tree/' + id, function(data) {
          initTree(data);
        });
      }

    });
  }

  initTree(nodz);

</script>
