<!-- Page-Title -->
<div class="row">
  <div class="col-sm-12 m-b-23">
    <h4 class="page-title"><%= t('.title') %></h4>
  </div>
</div>

<% if node.present? %>
<div class="row">
  <div class="col-sm-12">
    <div class="card-box">
    <div class="table-responsive">
       <table class="table table-bordered table-sm">
        <tr>
          <td><strong><%= t('.left_pv') %></strong></td>
          <td><%= number_with_delimiter node.left_leg_accumulated_score.to_i %></td>
          <td><strong><%= t('left_count') %></strong></td>
          <td><%= number_with_delimiter node.left_count %></td>
        </tr>
        <tr>
          <td><strong><%= t('.right_pv') %></strong></td>
          <td><%= number_with_delimiter node.right_leg_accumulated_score.to_i %></td>
          <td><strong><%= t('right_count') %></strong></td>
          <td><%= number_with_delimiter node.right_count %></td>
        </tr>
        <tr>
          <td><strong><%= t('.username') %></strong></td>
          <td><%= node.user.username %> (<%= node.user.current_career.try(:name) %>)</td>
          <td><strong><%= t('.sponsor') %></strong></td>
          <td><%= node.user.sponsor && node.user.sponsor.username %></td>
        </tr>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
      <div class="panel panel-default">
          <div class="panel-body">
              <div class="row">
                <div class="col-md-6">
                  <%= link_to backoffice_binary_tree_path(current_user.binary_node), class: 'btn btn-default' do %>
                    <i class="fa fa-angle-double-up"></i>
                  <% end %>
                  <%= link_to backoffice_binary_tree_path(node.parent), class: 'btn btn-primary' do %>
                    <i class="fa fa-angle-up"></i>
                  <% end if node.parent.present? %>
                </div>
                <div class="col-md-6">
                  <%= form_tag backoffice_binary_tree_path(node), method: :get do %>
                    <div class="form-group">
                      <div class="input-group">
                          <span class="input-group-btn">
                            <button type="submit" class="btn waves-effect waves-light btn-default"><i class="fa fa-search"></i></button>
                          </span>
                          <input type="hidden" name="locale" value="<%= params[:locale] %>">
                          <input type="text" class="form-control" name="username" value="<%= params[:username] %>" placeholder="<%= t('.search') %>">
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
              <div class="row">
                  <div class="col-xs-12">
                  <div class="table-responsive">
                    <table class="table binary-tree m-t-30">
                      <% cols = 4 %>
                      <% nodes = [@node] %>
                      <tr class="text-center">
                        <td colspan="<%= 2 ** cols %>">
                          <%= image_tag(node.user.current_career.try(:image_path),
                            class: 'tree-node',
                              data: {
                                username: node.user.username,
                                sponsor: node.user.sponsor.try(:username) || '',
                                left_pv: node.left_leg_accumulated_score,
                                right_pv: node.right_leg_accumulated_score,
                                career: node.user.current_career.try(:name) || '',
                              }
                            ) if node.user.current_career.present? %>
                        </td>
                      </tr>
                      <tr class="text-center">
                        <td colspan="<%= 2 ** cols %>"></td>
                      </tr>

                      <% for x in 1..cols %>

                        <% new_nodes = Array.new(2 ** (x-1)) %>

                        <tr class="text-center">
                          <% (2 ** (x - 1)).times do |i| %>
                            <% current_node = nodes[i] %>
                            <td colspan="<%= 2 ** (cols - x) %>">
                              <% if current_node && current_node.left_child_id %>
                                <%= link_to(
                                    backoffice_binary_tree_path(current_node.left_child),
                                    class: 'tree-node',
                                    data: {
                                      username: current_node.left_child.user.username,
                                      sponsor: current_node.left_child.user.sponsor.username,
                                      left_pv: current_node.left_child.left_leg_accumulated_score,
                                      right_pv: current_node.left_child.right_leg_accumulated_score,
                                      career: current_node.left_child.user.current_career.try(:name),
                                    }
                                  ) do %>
                                  <%= image_tag(current_node.left_child.user.current_career.try(:image_path) || 'careers/inactive.png') %>
                                <% end %>
                              <% else %>
                                <%= image_tag('packages/inactive.png') %>
                              <% end %>
                            </td>
                            <td colspan="<%= 2 ** (cols - x) %>">
                              <% if current_node && current_node.right_child_id %>
                                <%= link_to(
                                    backoffice_binary_tree_path(current_node.right_child),
                                    class: 'tree-node',
                                    data: {
                                      username: current_node.right_child.user.username,
                                      sponsor: current_node.right_child.user.sponsor.username,
                                      left_pv: current_node.right_child.left_leg_accumulated_score,
                                      right_pv: current_node.right_child.right_leg_accumulated_score,
                                      career: current_node.right_child.user.current_career.try(:name)
                                    }
                                  ) do %>
                                  <%= image_tag(current_node.right_child.user.current_career.try(:image_path) || 'careers/inactive.png') %>
                                <% end %>
                              <% else %>
                                <%= image_tag('packages/inactive.png') %>
                              <% end %>
                            </td>

                            <% if current_node.present? %>
                              <% new_nodes[2*i]     = current_node.left_child %>
                              <% new_nodes[2*i + 1] = current_node.right_child %>
                            <% end %>
                          <% end %>
                        </tr>

                        <% nodes = new_nodes %>

                        <% if x != cols %>
                          <tr class="text-center">
                            <% (2 ** x).times do %>
                              <td colspan="<%= 2 ** (cols - x) %>"></td>
                            <% end %>
                          </tr>
                        <% end %>

                      <% end %>
                    </table>
                    </div>
                  </div>
              </div>
          </div>
      </div>
  </div>
</div>
<% end %>

<!-- Careers -->
<div class="row">
    <div class="col-xs-12">
    <div class="table-responsive">
      <table class="text-center table binary-tree m-t-30" style="margin: 0 auto;">
      <% Career.qualifying.each_with_index do |career, i| %>
        <% if i % 5 == 0 %>
          <tr>
        <% end %>
          <td>
            <div class="career-legend m-l-10 m-r-10">
              <%= image_tag(career.image_path, class: 'img-circle thumb-md') %>
              <h5><%= t(career.name) %></h5>
            </div>
          </td>
          <% if i % 5 == 4 %>
            </tr>
          <% end %>
      <% end %>
    </table>
    </div>
  </div>
</div>

<div class='hide'>
  <span id='i18n-user'> <%= t('attributes.user') %> </span>
  <span id='i18n-sponsor'> <%= t('attributes.sponsor') %> </span>
  <span id='i18n-career'> <%= t('career') %> </span>
  <span id='i18n-right-leg-score'> <%= t('backoffice.binary_tree.show.right_pv') %> </span>
  <span id='i18n-left-leg-score'> <%= t('backoffice.binary_tree.show.left_pv') %> </span>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(event) {
  $('.tree-node').webuiPopover({
    trigger: 'hover',
    html: true,
    content: function() {
      let $this = $(this);

      const user_label = $('span#i18n-user').html();
      const sponsor_label = $('span#i18n-sponsor').html();
      const career_label = $('span#i18n-career').html();
      const right_leg_score_label = $('span#i18n-right-leg-score').html();
      const left_leg_score_label = $('span#i18n-left-leg-score').html();

      var html = '' +
      '<strong>' + user_label + ':</strong> ' + $this.data('username') +
      '<br /> <strong>'+ sponsor_label + ':</strong> ' + $this.data('sponsor') +
      '<br /> <strong>' + career_label + ':</strong> ' + $this.data('career') +
      '<br /> <strong>' + left_leg_score_label + ':</strong> ' + $this.data('left-pv') +
      '<br /> <strong>' + right_leg_score_label + ':</strong> ' + $this.data('right-pv');

      return html;
    }
  });
})

</script>
