<style media="screen">
  #pie-chart {
    min-height: 250px;
  }
  #pie-chart2 {
    min-height: 250px;
  }
  #pie-chart3 {
    min-height: 250px;
  }
  #pie-chart4 {
    min-height: 250px;
  }
  #pie-chart5 {
    min-height: 250px;
  }
  #pie-refresh {
    min-height: 250px;
  }

</style>
<br>
<div class="row linhaHome">
  <div class="col-md-2">
    <div class="dashboard-card">
      <div class="dashboard-card__label">
        <span><%= t(:account_status) %></span>
      </div>
      <% if current_user.active? %>
        <div class="dashboard-card__value label-default"><%= t(:active) %></div>
      <% else %>
        <div class="dashboard-card__value label-danger"><%= t(:inactive) %></div>
      <% end %>
    </div>
  </div>

  <div class="col-md-2">
    <div class="dashboard-card">
      <div class="dashboard-card__label">
        <span><%= t('defaults.point_qualifications') %></span>
      </div>
      <div class="dashboard-card__value label-success"><%= number_with_delimiter current_user.binary_node.shortter_leg_accumulated_score %></div>
    </div>
  </div>

  <div class="col-md-2">
    <div class="dashboard-card">
      <div class="dashboard-card__label">
        <span><%= t('binary_qualified') %></span>
      </div>
      <div class="dashboard-card__value label-success">
        <% if current_user.binary_qualified? %>
          <%= t('qualified') %>
        <% else %>
          <%= t('unqualified') %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-md-2">
    <div class="dashboard-card">
      <div class="dashboard-card__label">
        <span><%= t(:course) %></span>
      </div>
      <div class="dashboard-card__value label-warning">
        <%= current_user.try(:current_trail).try(:name) %>
      </div>
    </div>
  </div>

  <div class="col-md-2">
    <div class="dashboard-card">
      <div class="dashboard-card__label">
        <span><%= t(:career) %></span>
      </div>
      <div class="dashboard-card__value label-warning">
        <%= current_user.try(:current_career).try(:name) %>
      </div>
    </div>
  </div>

  <div class="col-md-2">
    <div class="dashboard-card">
      <div class="dashboard-card__label">
        <span><%= t(:next) + ' ' + t(:career) %></span>
      </div>
      <div class="dashboard-card__value label-info">
        <%= current_user.next_career_kind.try(:name) %>
      </div>
    </div>
  </div>
</div><br><br>

<div class="row">
  <div class="col-md-2">
    <div class="card" style="background-color: rgba(245, 245, 245, 0.0); border: none;">
      <label class="dashboard-card__label">
        <%= t(:account_earnings_limit) %>
        <div id="account_earnings_limit">
        </div>
      </label>

      <div id="pie-chart">
      </div>
    </div>


  </div>
  <div class="col-md-2">
    <div class="card" style="background-color: rgba(245, 245, 245, 0.0); border: none;">
      <label class="dashboard-card__label">
        <%= t(:balance) %>
        <div id="balance">
        </div>
      </label>

      <div id="pie-chart2">
      </div>
    </div>


  </div>
  <div class="col-md-2">
    <div class="card" style="background-color: rgba(245, 245, 245, 0.0); border: none;">
      <label class="dashboard-card__label">
        <strong class="text-black">
          <%= t(:total_bonus) %>
          <div id="total_bonus">
          </div>
        </strong>
      </label>

      <div id="pie-chart3">
      </div>
    </div>


  </div>
  <div class="col-md-2">
    <div class="card" style="background-color: rgba(245, 245, 245, 0.0); border: none;">
      <label class="dashboard-card__label">
        <%= t(:unilevel_affiliates_count) %>
        <div id="unilevel_affiliates_count">
        </div>
      </label>

      <div id="pie-chart4">
      </div>
    </div>


  </div>
  <div class="col-md-2">
    <div class="card" style="background-color: rgba(245, 245, 245, 0.0); border: none;">
      <label class="dashboard-card__label">
        <%= t(:binary_affiliates_count) %>
        <div id="binary_affiliates_count">
        </div>
      </label>

      <div id="pie-chart5">
      </div>
    </div>


  </div>
  <div class="col-md-2">
    <div id="pie-refresh" class="panel text-center" style="background-color: rgba(245, 245, 245, 0.0); border: none;">
      <br><br><br><br><br><br><br>
      <div class="panel-body">
        <a href="#" class="btn btn-info btn-lg bt-toggle" value="backoffice/dashboard/user_data.json">
          <i class="fa fa-refresh"></i> <%= t(:refresh) %>
        </a>
      </div>
    </div>
  </div>
</div><br><br>

<div class="row">
  <div class="col-md-4">
    <div class="dashboard-card-box">
      <div class="dashboard-card-box__title">
      <span class="text-white"><%= t(:withdrawal) %></span>
      </div>
        <div class="inbox-widget mx-box" tabindex="5000" style="overflow: hidden; outline: none;">
          <table class="table table-bordered table-highlight">
            <thead class="table-highlight__head">
              <tr>
                <th><%= t(:datae) %></th>
                <th><%= t(:status) %></th>
                <th><%= t(:value) %></th>
              </tr>
            </thead>
            <% last_withdrawals.each do |withdraw| %>
              <tr>
                <td><%= l withdraw.created_at, format: :short %></td>
                <td><%= t withdraw.status %></td>
                <td><%= number_to_currency withdraw.gross_amount_cents %></td>
              </tr>
            <% end %>
            <% if last_withdrawals.blank? %>
              <tr>
                <td colspan="3" class="text-center"><%= t('no_data') %></td>
              </tr>
            <% end %>
          </table>
        </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="dashboard-card-box">
      <div class="dashboard-card-box__title">
        <span class="text-white"><%= t(:last_qualifications) %></span>
      </div>
      <div class="dashboard-card-box__container inbox-widget mx-box" tabindex="5000" style="overflow: hidden; outline: none;">
        <% last_qualifications.each do |qualification| %>
        <div class="inbox-item">
          <p class="inbox-item-author"><%= qualification.user.username %></p>
          <p class="inbox-item-text"><%= qualification.old_career ? t(qualification.old_career) : 'Cliente' %>
            <i class="fa fa-arrow-right"></i> <%= t qualification.new_career %>
          </p>
        </div>
        <% end %>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="dashboard-card-box">
      <div class="dashboard-card-box__title">
        <span class="text-white"><%= t(:last_posts) %></span>
      </div>
      <div class="dashboard-card-box__containe">
        <div class="inbox-widget mx-box" tabindex="5000" style="overflow: hidden; outline: none;">

        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="support-material">
      <div class="support-material__left-box">
        <%= link_to t(:download_support_material), backoffice_downloads_path %>
      </div>

      <div class="support-material__right-box">
          <ul class="support-material__download-list">

            <li style="padding-right: 24px;">
              <a href="#" target="blank">
                <div>
                  <%= image_tag 'download-list/presentation.jpg' %>
                </div>
                <div><%= t(:business_presentation) %></div>
              </a>
            </li>

            <li style="padding-right: 24px;">
              <a href="#" target="blank">
                <div>
                  <%= image_tag 'download-list/video.jpg' %>
                </div>
                <div> <%= ENV['COMPANY_NAME'] %> </div>
              </a>
            </li>

            <li style="padding-right: 24px;">
              <a href="#" target="blank">
                <div>
                  <%= image_tag 'download-list/paper.jpg' %>
                </div>
                <div><%= t(:adhesion_contract) %></div>
              </a>
            </li>

          </ul>
      </div>
    </div>
  </div>
</div>
<div id="locale" value="<%= params[:locale] %>">

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js">

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.2/raphael-min.js">

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.0/morris.min.js"></script>

<script type="text/javascript">
  const pieCharts = ["", "2", "3", "4", "5"]
  const locale = $("#locale").attr('value');
  const account_earnings_limit = $('#account_earnings_limit');
  const balance = $('#balance');
  const total_bonus = $('#total_bonus');
  const unilevel_affiliates_count = $('#unilevel_affiliates_count');
  const binary_affiliates_count = $('#binary_affiliates_count');

  $(document).on('click', '.bt-toggle', {}, function(e) {
    charts_cleaner();

    getInstance();
  });

  function charts_cleaner() {
    pieCharts.forEach(function(item, _, _) {
      $('#pie-chart' + item).empty();
    })
    account_earnings_limit.empty();
    balance.empty();
    total_bonus.empty();
    unilevel_affiliates_count.empty();
    binary_affiliates_count.empty();
    return false;
  };


  async function getInstance() {
    let path = '/backoffice/dashboard/user_data.json?locale=' + locale
    try {
      let response = await fetch(path);
      if (response.ok) {
        let instances = await response.json();
        let user_data = JSON.parse(JSON.stringify(instances.data))
        let labels = JSON.parse(JSON.stringify(instances.labels))
        let bonus = user_data.bonus
        let earnings = user_data.earnings
        let balances = user_data.balances
        let unilevel_counts = user_data.unilevel_counts
        let binary_count = user_data.binary_count
        account_earnings_limit.append(earnings.account_earnings_limit);
        balance.append(balances.balance);
        total_bonus.append(bonus.bonus_total);
        unilevel_affiliates_count.append(unilevel_counts.unilevel_affiliates_count)
        binary_affiliates_count.append(binary_count.binary_affiliates_count)
        Morris.Donut({
          element: 'pie-chart',
          colors: ["#00a65a", "#555299"],
          data: [
            {label: labels.receivable_amount, value: earnings.receivable_amount},
            {label: labels.received_amount, value: earnings.received_amount}
          ]
        });
        Morris.Donut({
          element: 'pie-chart2',
          colors: ["#f39c12", "#3c8dbc"],
          data: [
            {label: labels.available_balance, value: balances.available_balance},
            {label: labels.blocked_balance, value: balances.blocked_balance},
          ]
        });

        Morris.Donut({
          element: 'pie-chart3',
          colors: ["#00a65a", "#f39c12", "#3c8dbc", "#dd4b39"],
          data: [
            {label: labels.binary_bonus, value: bonus.binary_bonus},
            {label: labels.matching_bonus, value: bonus.matching_bonus},
            {label: labels.pool_trade_bonus, value: bonus.pool_trade_bonus},
            {label: labels.residual_bonus, value: bonus.residual_bonus}
          ]
        });

        Morris.Donut({
          element: 'pie-chart4',
          colors: ["#3c8dbc", "#dd4b39", "#555299"],
          data: [
            {label: labels.unilevel_affiliates_left_count, value: unilevel_counts.unilevel_affiliates_left_count},
            {label: labels.unilevel_affiliates_right_count, value: unilevel_counts.unilevel_affiliates_right_count}
          ]
        });

        Morris.Donut({
          element: 'pie-chart5',
          colors: ["#00a65a", "#f39c12"],
          data: [
            {label: labels.binary_affiliates_left_count, value: binary_count.binary_affiliates_left_count},
            {label: labels.binary_affiliates_right_count, value: binary_count.binary_affiliates_right_count}
          ]
        });


        return instances;
      }
      throw new Error('Request failed!');
    }
    catch(error) {
      console.log(error);
    }
  }

  $(document).ready(function(){
    getInstance();
  });

</script>
