<%= stylesheet_link_tag 'click-tok-theme/team_dashboard' %>
<%= stylesheet_link_tag 'click-tok-theme/financial_dashboard' %>

<div>
  <div class="page">
    <div class="back-button">
      <%= image_tag('icons/back.svg') %>
      <%= link_to t(:back), :back %>
    </div>
    <div class="f-balance-area">
      <div class="balance-title t-break-line">
      <%= link_to backoffice_direct_nominees_list_index_path, class:'text-white' do %>
        <%= t(:my) %>
        <span><%= t(:community) %></span>
        <% end %>
      </div>

      <div class="balance-value">
        <%= @unilevel_nodes.count %>
      </div>
    </div>
    <%= form_tag(backoffice_team_dashboard_index_path, method: :get) do %>
      <div class="login-fields t-fw">
        <div class="field-icon">
          <%= image_tag('icons/search.svg') %>
        </div>
        <%= text_field_tag(:q, params[:q], class:"input-description") %>
      </div>
    <% end %>
    <div class="t-team-owner-avatar">
      <div class="t-owner-avatar">
        <div>
          <% if @user.avatar.try(:path).present? %>
            <%= cl_image_tag(@user.avatar.try(:path), { class: 'icons' }) %>
          <% else %>
            <%= image_tag 'icons/user.svg', class: 'icons' %>
          <% end %>
        </div>
      </div>
      <br>
      <span class="text-center"><%= @user.name.presence || t(:guest) %></span>
    </div>

    <div class="t-team-network-avatar">
      <% direct_children(@unilevel_nodes).each do |child| %>
        <div class="t-teste">
          <div class="t-align">
            <%= link_to backoffice_team_dashboard_index_path(user: child.user) do %>
              <% if child.user.avatar.try(:path).present? %>
                <%= cl_image_tag(child.user.avatar.try(:path), { class: 'icons' }) %>
              <% else %>
                <%= image_tag 'icons/user.svg', class: 'icons' %>
              <% end %>
            <% end %>
          </div>
          <span class="text-center"><%= (child.user.name.presence || t(:guest)).truncate(12) %></span>
        </div>
      <% end %>
    </div>
    <% nodes_per_depth = @unilevel_nodes.group_by(&:ancestry_depth) %>
    <% total_nodes = nodes_per_depth.values.size  %>
    <% first_generation_nodes_size = nodes_per_depth[@current_node.depth + 1].try(:size).to_f  %>

    <% nodes_per_depth.slice(*nodes_per_depth.keys[0..4]).each do |depth, nodes| %>
      <div class="f-balance-area">
        <div class="balance-title t-break-line">
          <%= t(:total) %>
          <span><%= depth - @current_node.depth %> <%= t(:generation) %></span>
        </div>

        <div class="balance-value">
          <%= nodes.size %>
        </div>
      </div>
    <% end %>

    <div class="products-list">
      <div class="f-options-box f-options-box-l">
        <div class="f-box-title">
          <%= t(:direct_referral) %>
        </div>
        <div class="f-box-icon">
          <span class="half text-center"><%= t(:direct_referral_text) %></span>
        </div>
      </div>

      <div class="f-options-box f-options-box-r">
        <div class="f-box-title">
          <%= t(:indirect_referral)%>
        </div>
        <div class="f-box-icon">
          <span class="half text-center"><%= t(:indirect_referral_text) %></span>
        </div>
      </div>

      <div class="f-options-box f-options-box-l t-margin-bottom">
        <div class="f-box-title">
          <%= t(:earnings_by_campaign) %>
        </div>
        <div class="f-box-icon">
          <% last_order = @user.orders.paid.last %>
          <% amount = last_order.try(:products).try(:first).try(:earnings_per_campaign).to_f %>
          <span class="half text-center"><%= t('earnings_by_campaign_text') %></span>
        </div>
      </div>

      <div class="f-options-box f-options-box-r t-margin-bottom">
        <div class="f-box-title">
          <%= t(:recurring_revenue) %>
        </div>
        <div class="f-box-icon">
          <span class="half text-center">
            <%= t(:recurring_revenue_text) %>
          </span>
        </div>
      </div>
    </div>
  </div>
</div>
